name: Build FRICC2LOAD Extension for Windows

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-windows:
    runs-on: windows-2022

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    # 1. Download Official PHP SDK (works with VS17)
    - name: Download PHP SDK
      run: |
        Invoke-WebRequest -Uri "https://windows.php.net/downloads/php-sdk/php-sdk-2.2.0.zip" -OutFile "C:/php-sdk.zip"
        Expand-Archive "C:/php-sdk.zip" -DestinationPath "C:/php-sdk"

    # 2. Download php-src for PHP 8.2
    - name: Download php-src 8.2
      run: |
        Invoke-WebRequest -Uri "https://github.com/php/php-src/archive/refs/heads/PHP-8.2.zip" -OutFile "C:/php-src.zip"
        Expand-Archive "C:/php-src.zip" -DestinationPath "C:/"

    # 3. Initialize Build Tree
    - name: Initialize PHP Build Tree
      run: |
        cd C:/php-sdk
        .\phpsdk-vs17-x64.bat -t phpdev

    # 4. Move php-src into build tree
    - name: Move php-src
      run: |
        Move-Item -Path "C:/php-src-PHP-8.2" -Destination "C:/php-sdk/phpdev/php-src" -Force

    # 5. Copy Extension Folder
    - name: Copy fricc2load
      run: |
        Copy-Item -Path "${{ github.workspace }}/fricc2load" -Destination "C:/php-sdk/phpdev/php-src/ext/fricc2load" -Recurse -Force

    # 6. Build DLL
    - name: Build Extension
      run: |
        cd C:/php-sdk/phpdev/php-src
        buildconf.bat
        cscript configure.js --enable-cli --disable-zts --enable-fricc2load=shared --with-mp=64
        nmake

    # 7. Upload DLL
    - name: Upload DLL
      uses: actions/upload-artifact@v4
      with:
        name: fricc2load-php82-windows
        path: C:/php-sdk/phpdev/php-src/x64/Release/php_fricc2load.dll
