name: Build fricc2load on Windows

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2022
    defaults:
      run:
        shell: powershell

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # 1️⃣ تحميل PHP NTS + Devel Pack
      - name: Download PHP
        run: |
          Invoke-WebRequest -Uri "https://windows.php.net/downloads/releases/php-8.2.29-nts-Win32-vs16-x64.zip" -OutFile "$env:TEMP\php.zip"
          Expand-Archive "$env:TEMP\php.zip" -DestinationPath "$env:TEMP\php"

      - name: Download PHP Devel Pack
        run: |
          Invoke-WebRequest -Uri "https://windows.php.net/downloads/releases/php-devel-pack-8.2.29-nts-Win32-vs16-x64.zip" -OutFile "$env:TEMP\php-devel.zip"
          Expand-Archive "$env:TEMP\php-devel.zip" -DestinationPath "$env:TEMP\php-devel"

      # 2️⃣ إعداد البيئة
      - name: Set PHP paths
        run: |
          $phpDir = "$env:TEMP\php\php-8.2.29-nts-Win32-vs16-x64"
          $develDir = "$env:TEMP\php-devel\php-devel-8.2.29-nts-Win32-vs16-x64"
          echo "PHP_DIR=$phpDir" >> $env:GITHUB_ENV
          echo "DEVEL_DIR=$develDir" >> $env:GITHUB_ENV
          setx PATH "$phpDir;$develDir\bin;%PATH%"

      # 3️⃣ بناء fricc2load
      - name: Build fricc2load
        run: |
          cd ${{ github.workspace }}
          # نفترض أن لديك configure.js في المشروع
          node configure.js
          nmake

      # 4️⃣ حفظ DLL الناتج
      - name: Upload built DLL
        uses: actions/upload-artifact@v3
        with:
          name: fricc2load-dll
          path: |
            ${{ github.workspace }}\*.dll
