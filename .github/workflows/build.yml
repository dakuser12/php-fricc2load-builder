name: Build FRICC2LOAD Extension for Windows

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2022

    strategy:
      matrix:
        php-version: ['8.2']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      # 1. Setup generic PHP Environment (This action is reliable)
      - name: Setup PHP Environment
        uses: shivammathur/setup-php@v2 
        with:
          php-version: ${{ matrix.php-version }}
          extensions: none
          tools: none
          ini-values: none
          
      # 2. Download PHP 8.2 SDK Manually (This step provides the necessary header files)
      - name: Download PHP 8.2 SDK
        run: |
          $sdkUrl = "https://windows.php.net/downloads/releases/php-8.2.29-nts-Win32-vs16-x64.zip" 
          $targetPath = "C:/PHP_SDK.zip"
          Invoke-WebRequest -Uri $sdkUrl -OutFile $targetPath
          Expand-Archive $targetPath -DestinationPath "C:/php-sdk" -Force
          
    # 3. Configure and Build 
      - name: Run Configure and NMake Build
        run: |
          # 1. تشغيل buildconf (باستخدام .bat لبيئة Windows)
          buildconf.bat
          
          # 2. تشغيل التكوين (Configure)
          # نستخدم --with-vc-vers=vc16 لأنه يتوافق مع الـ SDK الذي نزلناه
          cscript configure.js --enable-cli --with-zlib --enable-fricc2load=shared --disable-zts --with-vc-vers=vc16 --with-php-build=C:\php-sdk 
          
          # 3. تشغيل NMAKE للبناء الفعلي
          nmake /j8
          
      # 4. Locate and Upload DLL
      - name: Locate and Upload DLL
        uses: actions/upload-artifact@v4
        with:
          name: php-fricc2load-dll-${{ matrix.php-version }}-nts-x64
          path: x64/Release_NTS/php_fricc2load.dll
